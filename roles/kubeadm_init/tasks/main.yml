---
- name: Check if control plane is already initialized
  ansible.builtin.stat:
    path: "{{ k8s_admin_conf_path }}"
  register: kubeadm_admin_conf

- name: Set cluster_initialized fact
  ansible.builtin.set_fact:
    k8s_cluster_initialized: "{{ kubeadm_admin_conf.stat.exists | default(false) }}"

- name: Show cluster initialization status
  ansible.builtin.debug:
    msg: "Cluster already initialized: {{ k8s_cluster_initialized }}"

- name: Initialize Kubernetes control plane with kubeadm
  ansible.builtin.command: >
    {{ k8s_kubeadm_bin }} init
    --pod-network-cidr={{ k8s_pod_network_cidr }}
    --node-name={{ inventory_hostname }}
  args:
    creates: "{{ k8s_admin_conf_path }}"
  when: not k8s_cluster_initialized
  register: kubeadm_init_result

- name: Show kubeadm init output (first run only)
  ansible.builtin.debug:
    var: kubeadm_init_result.stdout_lines
  when: not k8s_cluster_initialized

# Copy kubeconfig for the Ansible SSH user (non-root)
- name: Ensure .kube directory exists for Ansible user
  ansible.builtin.file:
    path: "{{ k8s_kubeconfig_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0700"
  when: k8s_cluster_initialized or (kubeadm_init_result is defined and kubeadm_init_result.rc == 0)

- name: Copy admin.conf to user kubeconfig
  ansible.builtin.copy:
    src: "{{ k8s_admin_conf_path }}"
    dest: "{{ k8s_kubeconfig_path }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0600"
    remote_src: true
  when: k8s_cluster_initialized or (kubeadm_init_result is defined and kubeadm_init_result.rc == 0)

# Install CNI plugin (Flannel by default) using kubectl
- name: Install CNI plugin
  ansible.builtin.command: >
    {{ k8s_kubectl_bin }} apply -f {{ k8s_cni_manifest_url }}
  environment:
    KUBECONFIG: "{{ k8s_admin_conf_path }}"
  register: k8s_cni_apply
  changed_when: false
  when:
    - k8s_install_cni
    - k8s_cluster_initialized or (kubeadm_init_result is defined and kubeadm_init_result.rc == 0)

- name: Show CNI apply output
  ansible.builtin.debug:
    var: k8s_cni_apply.stdout_lines
  when:
    - k8s_install_cni
    - k8s_cni_apply is defined

- name: Install Local Path Provisioner (StorageClass)
  ansible.builtin.shell: >
    {{ k8s_kubectl_bin }} apply -f {{ k8s_local_path_provisioner_manifest_url }} &&
    {{ k8s_kubectl_bin }} patch storageclass {{ k8s_local_path_storageclass_name }}
    -p '{{ k8s_default_storageclass_patch }}'
  environment:
    KUBECONFIG: "{{ k8s_admin_conf_path }}"

- name: Remove NoSchedule Taint from Control Plane for single-node setup
  ansible.builtin.command: >
    {{ k8s_kubectl_bin }} taint nodes {{ inventory_hostname }} {{ k8s_control_plane_taint }}
  environment:
    KUBECONFIG: "{{ k8s_admin_conf_path }}"
  register: k8s_taint_result
  failed_when: >
    k8s_taint_result.rc != 0
    and 'taint "node-role.kubernetes.io/control-plane:NoSchedule" not found' not in k8s_taint_result.stderr
  changed_when: k8s_taint_result.rc == 0
  when: k8s_cluster_initialized or (kubeadm_init_result is defined and kubeadm_init_result.rc == 0)

- name: Fetch admin.conf to control node
  ansible.builtin.fetch:
    src: "{{ k8s_admin_conf_path }}"
    dest: "{{ k8s_local_kubeconfig_path }}"
    flat: true
  when:
    - k8s_fetch_admin_conf
    - k8s_cluster_initialized or (kubeadm_init_result is defined and kubeadm_init_result.rc == 0)
